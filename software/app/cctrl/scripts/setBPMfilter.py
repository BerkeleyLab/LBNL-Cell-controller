#!/usr/bin/env python

# Load BPM cell filter with coefficients of 2nd order Butterworth
# with 60 Hz cutoff and FA sampling.
# Created in MATLAB by
#   Fsample = 499.64e6/328/152;
#   Fcutoff = 60;
#   [B,A]=butter(2,2*Fcutoff/Fsample,'low');
#   sys=filt(B,A,1/Fsample);
#   c=impulse(sys,299/Fsample)

import argparse
import epics

parser = argparse.ArgumentParser(description='Load BPM cell filter with default coefficients.', formatter_class=argparse.ArgumentDefaultsHelpFormatter)
parser.add_argument('-b', '--bpm', type=int, default=1, help='BPM number')
parser.add_argument('-s', '--sector', type=int, default=1, help='Sector number')
parser.add_argument('-p', '--prefix', default=None, help='PV name prefix')
parser.add_argument('-u', '--unity', action='store_true', help='Set filter to unity gain instead of second-order Butterworth')
parser.add_argument('-v', '--verbose', action='store_true', help='Show channel access operations')
args = parser.parse_args()

if (args.prefix == None):
    args.prefix = "SR%2.2dc:BPM%2.2d" % (args.sector, args.bpm)

filterCoefficients = [
      0.000344566480238728,
       0.00135993936218541,
       0.00266539888389875,
       0.00389955018783557,
       0.00506438669478649,
       0.00616189408257041,
       0.00719404795039835,
       0.00816281161813519,
       0.00907013405650389,
       0.00991794794430058,
        0.0107081678487182,
        0.0114426885249082,
         0.012123383330947,
        0.0127521027544118,
         0.013330673046815,
         0.013860894962191,
        0.0143445425961779,
        0.0147833623219874,
        0.0151790718197102,
        0.0155333591954587,
        0.0158478821869072,
        0.0161242674518474,
        0.0163641099364402,
        0.0165689723199046,
         0.016740384532449,
        0.0168798433433148,
         0.016988812015868,
        0.0170687200267401,
        0.0171209628460869,
         0.017146901776102,
        0.0171478638449894,
        0.0171251417536679,
        0.0170799938725485,
        0.0170136442857959,
        0.0169272828805519,
        0.0168220654786692,
        0.0166991140085709,
        0.0165595167149206,
        0.0164043284038546,
         0.016234570721596,
         0.016051232464338,
        0.0158552699173473,
        0.0156476072213083,
        0.0154291367639914,
        0.0152007195953929,
        0.0149631858645584,
        0.0147173352763653,
        0.0144639375665993,
        0.0142037329937236,
         0.013937432845797,
        0.0136657199610586,
        0.0133892492607524,
        0.0131086482928244,
        0.0128245177851782,
        0.0125374322072328,
        0.0122479403385774,
        0.0119565658435727,
        0.0116638078507971,
        0.0113701415362903,
        0.0110760187095921,
        0.0107818684016242,
        0.0104880974535095,
        0.0101950911054689,
       0.00990321358497985,
        0.0096128086934232,
       0.00932420039049022,
       0.00903769337565849,
       0.00875357366608791,
       0.00847210917032577,
       0.00819355025724716,
       0.00791813031969341,
       0.00764606633230654,
       0.00737755940309147,
        0.0071127953182707,
       0.00685194508002824,
       0.00659516543676971,
       0.00634259940555581,
       0.00609437678639441,
       0.00585061466810429,
       0.00561141792548996,
       0.00537687970759248,
       0.00514708191680577,
       0.00492209567867116,
       0.00470198180218574,
       0.00448679123048155,
       0.00427656548175324,
       0.00407133708033184,
        0.0038711299778209,
       0.00367595996422949,
       0.00348583506905367,
       0.00330075595227431,
       0.00312071628525493,
       0.00294570312153768,
       0.00277569725754989,
       0.00261067358324679,
       0.00245060142272835,
       0.00229544486488042,
       0.00214516308410114,
       0.00199971065118429,
       0.00185903783444114,
       0.00172309089115129,
       0.00159181234944218,
       0.00146514128070429,
       0.00134301356265721,
        0.0012253621331881,
       0.00111211723509107,
       0.00100320665184124,
      0.000898555934543271,
      0.000798088620198693,
      0.000701726441440955,
      0.000609389527891236,
      0.000520996599291577,
      0.000436465150575156,
      0.000355711629036364,
      0.000278651603765805,
      0.000205199927517422,
      0.000135270891176752,
      6.87783710007346e-05,
      5.63596880063508e-06,
     -5.42428547595116e-05,
     -0.000110944653575982,
     -0.000164555876056726,
     -0.000215162751437713,
     -0.000262851182291211,
     -0.000307706643053322,
     -0.000349814084398798,
     -0.000389257843291989,
     -0.000426121558543823,
     -0.000460488091705924,
     -0.000492439453134418,
      -0.00052205673305746,
     -0.000549420037482274,
     -0.000574608428779304,
      -0.00059769987078305,
     -0.000618771178251249,
     -0.000637897970526268,
     -0.000655154629244846,
     -0.000670614259944746,
     -0.000684348657419334,
     -0.000696428274673652,
     -0.000706922195338191,
     -0.000715898109399249,
     -0.000723422292107472,
     -0.000729559585929021,
     -0.000734373385406578,
     -0.000737925624800321,
     -0.000740276768381858,
     -0.000741485803257063,
     -0.000741610234596679,
     -0.000740706083156522,
     -0.000738827884972073,
     -0.000736028693115242,
     -0.000732360081404025,
     -0.000727872149958777,
     -0.000722613532501767,
     -0.000716631405299636,
     -0.000709971497651314,
     -0.000702678103826881,
     -0.000694794096365729,
     -0.000686360940645294,
     -0.000677418710634428,
      -0.00066800610574834,
     -0.000658160468724803,
     -0.000647917804444069,
     -0.000637312799617668,
     -0.000626378843273934,
     -0.000615148047970754,
     -0.000603651271668616,
     -0.000591918140199605,
     -0.000579977070270504,
     -0.000567855292940624,
     -0.000555578877517404,
     -0.000543172755815211,
     -0.000530660746725078,
     -0.000518065581045417,
     -0.000505408926525956,
     -0.000492711413079333,
     -0.000479992658116929,
     -0.000467271291967556,
     -0.000454564983339706,
     -0.000441890464789984,
     -0.000429263558162313,
     -0.000416699199964367,
     -0.000404211466649501,
     -0.000391813599774238,
     -0.000379518031003068,
     -0.000367336406934036,
     -0.000355279613720159,
     -0.000343357801463329,
      -0.00033158040835887,
     -0.000319956184570381,
     -0.000308493215815938,
     -0.000297198946648103,
     -0.000286080203411512,
      -0.00027514321686311,
     -0.000264393644441329,
     -0.000253836592171708,
     -0.000243476636197603,
     -0.000233317843925719,
     -0.000223363794777297,
     -0.000213617600536772,
     -0.000204081925290716,
     -0.000194759004950808,
     -0.000185650666355479,
     -0.000176758345945729,
     -0.000168083108011444,
     -0.000159625662505305,
     -0.000151386382422155,
     -0.000143365320742368,
     -0.000135562226938467,
     -0.000127976563044867,
     -0.000120607519291218,
     -0.000113454029300433,
     -0.000106514784852977,
      -9.9788250219567e-05,
     -9.32726760648754e-05,
     -8.69661129252989e-05,
     -8.08664242642903e-05,
     -7.49712991091409e-05,
     -6.92782642734839e-05,
     -6.37846961701345e-05,
     -5.84878322192113e-05,
     -5.33847818567825e-05,
     -4.84725371495605e-05,
      -4.3747983021427e-05,
     -3.92079070978012e-05,
     -3.48490091740857e-05,
     -3.06679103146138e-05,
     -2.66611615887011e-05,
     -2.28252524505635e-05,
      -1.9156618770001e-05,
     -1.56516505208735e-05,
     -1.23066991345009e-05,
     -9.11808452521231e-06,
     -6.08210179534759e-06,
     -3.19502762707657e-06,
     -4.53126368452181e-07,
      2.14734417884917e-06,
      4.61012726262171e-06,
      6.93896196656745e-06,
      9.13757827258207e-06,
      1.12096923914037e-05,
      1.31590023541567e-05,
      1.49891838573495e-05,
      1.67038863539218e-05,
      1.83067293829824e-05,
      1.98012991309275e-05,
      2.11911452166946e-05,
      2.24797776939677e-05,
      2.36706642632274e-05,
      2.47672276866158e-05,
      2.57728433986719e-05,
       2.6690837306082e-05,
      2.75244837696862e-05,
      2.82770037620784e-05,
      2.89515631942424e-05,
       2.9551271404774e-05,
      3.00791798053452e-05,
      3.05382806761857e-05,
      3.09315061054672e-05,
      3.12617270665986e-05,
      3.15317526275573e-05,
       3.1744329286507e-05,
      3.19021404280742e-05,
      3.20078058947814e-05,
      3.20638816682624e-05,
      3.20728596550102e-05,
      3.20371675715383e-05,
       3.1959168923962e-05,
      3.18411630771368e-05,
      3.16853854086188e-05,
      3.14940075428394e-05,
      3.12691376610171e-05,
      3.10128208824542e-05,
      3.07270397129955e-05,
        3.041371455655e-05,
      3.00747042857046e-05,
       2.9711806867582e-05,
       2.9326760041216e-05,
      2.89212420428443e-05,
      2.84968723756346e-05,
      2.80552126204818e-05,
      2.75977672846308e-05,
      2.71259846849962e-05,
      2.66412578631626e-05,
       2.6144925529164e-05,
      2.56382730312501e-05,
      2.51225333489572e-05,
      2.45988881069062e-05,
      2.40684686068584e-05,
      2.35323568756588e-05,
      2.29915867268013e-05,
      2.24471448334456e-05,
      2.18999718108138e-05,
      2.13509633059899e-05,
      2.08009710932354e-05,
      2.02508041730259e-05,
      1.97012298731017e-05,
      1.91529749499105e-05,
      1.86067266889022e-05 ]


if (args.unity):
    filterCoefficients[0] = 1.0
    for i in range(1,300): filterCoefficients[i] = 0.0

for plane in ['X', 'Y']:
    pv = epics.PV(args.prefix + ':cellFilter' + plane)
    if (args.verbose): print 'Set %s' % (pv.pvname)
    pv.put(filterCoefficients, wait=True)
    if (pv.status != 1): print 'Unable to send filter coefficients to ' + pv.pvname
